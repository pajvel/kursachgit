{% extends 'base.html' %}
{% load static %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤{% endblock %}

{% block content %}

<section class="panel">
    <div class="panel-header" style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h2 class="panel-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
            <p class="panel-subtitle">
                –ë–æ–º–±–∞—Ä–¥–∏—Ä—ã, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã, –∫–∞—Ä—Ç–æ—á–∫–∏. –ü—Ä–∏ —Ä–∞–≤–Ω–æ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ –≤—ã—à–µ —Ç–æ—Ç, —É –∫–æ–≥–æ –º–µ–Ω—å—à–µ –º–∞—Ç—á–µ–π.
            </p>
        </div>
        <a href="{% url 'index' %}" class="btn btn-ghost btn-small">
            ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </a>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="panel-block" style="margin-bottom:10px;">
        <div class="event-type-pills">
            {% with q_team=team_id q_pos=position %}
                {% if q_team or q_pos %}
                    {% with "&team="|add:q_team as tparam %}
                        {% with "&position="|add:q_pos as pparam %}
                            <a href="?tab=overview{{ tparam }}{{ pparam }}"
                               class="event-pill {% if tab == 'overview' %}active{% endif %}">
                                –ì–ª–∞–≤–Ω–∞—è
                            </a>
                            <a href="?tab=goals{{ tparam }}{{ pparam }}"
                               class="event-pill {% if tab == 'goals' %}active{% endif %}">
                                –ë–æ–º–±–∞—Ä–¥–∏—Ä—ã
                            </a>
                            <a href="?tab=assists{{ tparam }}{{ pparam }}"
                               class="event-pill {% if tab == 'assists' %}active{% endif %}">
                                –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã
                            </a>
                            <a href="?tab=yellow{{ tparam }}{{ pparam }}"
                               class="event-pill {% if tab == 'yellow' %}active{% endif %}">
                                –ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                            </a>
                            <a href="?tab=red{{ tparam }}{{ pparam }}"
                               class="event-pill {% if tab == 'red' %}active{% endif %}">
                                –ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                            </a>
                        {% endwith %}
                    {% endwith %}
                {% else %}
                    <a href="?tab=overview"
                       class="event-pill {% if tab == 'overview' %}active{% endif %}">
                        –ì–ª–∞–≤–Ω–∞—è
                    </a>
                    <a href="?tab=goals"
                       class="event-pill {% if tab == 'goals' %}active{% endif %}">
                        –ë–æ–º–±–∞—Ä–¥–∏—Ä—ã
                    </a>
                    <a href="?tab=assists"
                       class="event-pill {% if tab == 'assists' %}active{% endif %}">
                        –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã
                    </a>
                    <a href="?tab=yellow"
                       class="event-pill {% if tab == 'yellow' %}active{% endif %}">
                        –ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                    </a>
                    <a href="?tab=red"
                       class="event-pill {% if tab == 'red' %}active{% endif %}">
                        –ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                    </a>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="panel-block" style="margin-bottom:14px;">
        <form method="get" class="form-body" style="flex-direction:row; flex-wrap:wrap; gap:10px; align-items:flex-end;">
            <input type="hidden" name="tab" value="{{ tab }}">

            <div class="form-row" style="min-width:200px; max-width:260px;">
                <label class="form-label" for="id_team_filter">–ö–æ–º–∞–Ω–¥–∞</label>

                    <select name="team" id="id_team_filter" class="form-select">
                        <option value="">–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</option>
                        {% for t in teams %}
                            <option value="{{ t.id }}"
                                {% if team_id == t.id|stringformat:"s" %}selected{% endif %}>
                                {{ t.name }}
                            </option>
                        {% endfor %}
                    </select>

            </div>

            <div class="form-row" style="min-width:200px; max-width:260px;">
                <label class="form-label" for="id_position_filter">–ü–æ–∑–∏—Ü–∏—è</label>

                    <select name="position" id="id_position_filter" class="form-select">
                        <option value="">–õ—é–±–∞—è –ø–æ–∑–∏—Ü–∏—è</option>
                        {% for code, label in positions %}
                            <option value="{{ code }}"
                                {% if position == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
            </div>

            <div class="form-row">
                <label class="form-label">&nbsp;</label>
                <div style="display:flex; gap:6px;">
                    <button type="submit" class="btn btn-small btn-primary">
                        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                    {% if team_id or position %}
                        <a href="?tab={{ tab }}" class="btn btn-small btn-ghost">
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->

    {% if tab == 'overview' %}

        <div class="panel-block">
            <div class="cards-block">

                <!-- –ë–æ–º–±–∞—Ä–¥–∏—Ä—ã -->
                <div class="team-block">
                    <div class="team-block-header">
                        <h3 class="team-block-title">–ë–æ–º–±–∞—Ä–¥–∏—Ä—ã</h3>
                        <p class="team-block-subtitle">–¢–û–ü-3 –ø–æ –≥–æ–ª–∞–º</p>
                    </div>
                    <ol class="stat-ranking-list">
                        {% for p in top_scorers %}
                            <li class="stat-ranking-item {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
                                <div class="stat-rank-badge">{{ forloop.counter }}</div>

                                {% with p.team_players.all.0 as tp %}
                                <div class="stat-player">
                                    <div class="stat-player-avatar">
                                        <div class="emblem-sm">
                                            {% if tp and tp.team.emblem %}
                                                <img src="{% static 'emblems/' %}{{ tp.team.emblem }}" alt="{{ tp.team.name }}">
                                            {% elif tp %}
                                                <span>{{ tp.team.name|slice:":2"|upper }}</span>
                                            {% else %}
                                                <span>??</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="stat-player-main">
                                        <a href="{% url 'player_detail' p.id %}" class="link stat-player-name">
                                            {{ p.first_name }} {{ p.last_name }}
                                        </a>
                                        <div class="stat-player-meta muted">
                                            {% if tp %}
                                                {{ tp.team.name }}
                                            {% else %}
                                                –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã
                                            {% endif %}
                                            ¬∑
                                            {% if p.get_position_display %}
                                                {{ p.get_position_display }}
                                            {% else %}
                                                –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}

                                <div class="stat-side">
                                    <div class="stat-value">
                                        ‚öΩ {{ p.goals }}
                                        <span>–≥–æ–ª–æ–≤</span>
                                    </div>
                                    <div class="stat-games">
                                        {{ p.games }} –º–∞—Ç—á(–µ–π)
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="muted">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –≥–æ–ª–∞–º–∏.</li>
                        {% endfor %}
                    </ol>
                </div>

                <!-- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã -->
                <div class="team-block">
                    <div class="team-block-header">
                        <h3 class="team-block-title">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã</h3>
                        <p class="team-block-subtitle">–¢–û–ü-3 –ø–æ –≥–æ–ª–µ–≤—ã–º –ø–µ—Ä–µ–¥–∞—á–∞–º</p>
                    </div>
                    <ol class="stat-ranking-list">
                        {% for p in top_assistants %}
                            <li class="stat-ranking-item {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
                                <div class="stat-rank-badge">{{ forloop.counter }}</div>

                                {% with p.team_players.all.0 as tp %}
                                <div class="stat-player">
                                    <div class="stat-player-avatar">
                                        <div class="emblem-sm">
                                            {% if tp and tp.team.emblem %}
                                                <img src="{% static 'emblems/' %}{{ tp.team.emblem }}" alt="{{ tp.team.name }}">
                                            {% elif tp %}
                                                <span>{{ tp.team.name|slice:":2"|upper }}</span>
                                            {% else %}
                                                <span>??</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="stat-player-main">
                                        <a href="{% url 'player_detail' p.id %}" class="link stat-player-name">
                                            {{ p.first_name }} {{ p.last_name }}
                                        </a>
                                        <div class="stat-player-meta muted">
                                            {% if tp %}
                                                {{ tp.team.name }}
                                            {% else %}
                                                –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã
                                            {% endif %}
                                            ¬∑
                                            {% if p.get_position_display %}
                                                {{ p.get_position_display }}
                                            {% else %}
                                                –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}

                                <div class="stat-side">
                                    <div class="stat-value">
                                        üéØ {{ p.assists }}
                                        <span>–ø–µ—Ä–µ–¥–∞—á</span>
                                    </div>
                                    <div class="stat-games">
                                        {{ p.games }} –º–∞—Ç—á(–µ–π)
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="muted">–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –∞—Å—Å–∏—Å—Ç–∞–º–∏.</li>
                        {% endfor %}
                    </ol>
                </div>

                <!-- –ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="team-block">
                    <div class="team-block-header">
                        <h3 class="team-block-title">–ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
                        <p class="team-block-subtitle">–¢–û–ü-3 –ø–æ –ñ–ö</p>
                    </div>
                    <ol class="stat-ranking-list">
                        {% for p in top_yellow %}
                            <li class="stat-ranking-item {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
                                <div class="stat-rank-badge">{{ forloop.counter }}</div>

                                {% with p.team_players.all.0 as tp %}
                                <div class="stat-player">
                                    <div class="stat-player-avatar">
                                        <div class="emblem-sm">
                                            {% if tp and tp.team.emblem %}
                                                <img src="{% static 'emblems/' %}{{ tp.team.emblem }}" alt="{{ tp.team.name }}">
                                            {% elif tp %}
                                                <span>{{ tp.team.name|slice:":2"|upper }}</span>
                                            {% else %}
                                                <span>??</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="stat-player-main">
                                        <a href="{% url 'player_detail' p.id %}" class="link stat-player-name">
                                            {{ p.first_name }} {{ p.last_name }}
                                        </a>
                                        <div class="stat-player-meta muted">
                                            {% if tp %}
                                                {{ tp.team.name }}
                                            {% else %}
                                                –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã
                                            {% endif %}
                                            ¬∑
                                            {% if p.get_position_display %}
                                                {{ p.get_position_display }}
                                            {% else %}
                                                –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}

                                <div class="stat-side">
                                    <div class="stat-value">
                                        üü® {{ p.yellow_cards }}
                                        <span>–ñ–ö</span>
                                    </div>
                                    <div class="stat-games">
                                        {{ p.games }} –º–∞—Ç—á(–µ–π)
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="muted">–ù–µ—Ç –∂—ë–ª—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.</li>
                        {% endfor %}
                    </ol>
                </div>

                <!-- –ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="team-block">
                    <div class="team-block-header">
                        <h3 class="team-block-title">–ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h3>
                        <p class="team-block-subtitle">–¢–û–ü-3 –ø–æ –ö–ö</p>
                    </div>
                    <ol class="stat-ranking-list">
                        {% for p in top_red %}
                            <li class="stat-ranking-item {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
                                <div class="stat-rank-badge">{{ forloop.counter }}</div>

                                {% with p.team_players.all.0 as tp %}
                                <div class="stat-player">
                                    <div class="stat-player-avatar">
                                        <div class="emblem-sm">
                                            {% if tp and tp.team.emblem %}
                                                <img src="{% static 'emblems/' %}{{ tp.team.emblem }}" alt="{{ tp.team.name }}">
                                            {% elif tp %}
                                                <span>{{ tp.team.name|slice:":2"|upper }}</span>
                                            {% else %}
                                                <span>??</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="stat-player-main">
                                        <a href="{% url 'player_detail' p.id %}" class="link stat-player-name">
                                            {{ p.first_name }} {{ p.last_name }}
                                        </a>
                                        <div class="stat-player-meta muted">
                                            {% if tp %}
                                                {{ tp.team.name }}
                                            {% else %}
                                                –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã
                                            {% endif %}
                                            ¬∑
                                            {% if p.get_position_display %}
                                                {{ p.get_position_display }}
                                            {% else %}
                                                –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endwith %}

                                <div class="stat-side">
                                    <div class="stat-value">
                                        üü• {{ p.red_cards }}
                                        <span>–ö–ö</span>
                                    </div>
                                    <div class="stat-games">
                                        {{ p.games }} –º–∞—Ç—á(–µ–π)
                                    </div>
                                </div>
                            </li>
                        {% empty %}
                            <li class="muted">–ù–µ—Ç –∫—Ä–∞—Å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.</li>
                        {% endfor %}
                    </ol>
                </div>

            </div>
        </div>

    {% else %}
        {# –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞: –±–æ–º–±–∞—Ä–¥–∏—Ä—ã / –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã / –∫–∞—Ä—Ç–æ—á–∫–∏ #}
        <div class="panel-block">
            <h3 class="team-block-title" style="margin-bottom:6px;">
                {% if tab == 'goals' %}–ë–æ–º–±–∞—Ä–¥–∏—Ä—ã{% endif %}
                {% if tab == 'assists' %}–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã{% endif %}
                {% if tab == 'yellow' %}–ñ—ë–ª—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏{% endif %}
                {% if tab == 'red' %}–ö—Ä–∞—Å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏{% endif %}
            </h3>
            <p class="team-block-subtitle" style="margin-bottom:10px;">
                –¢–û–ü-10 –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—é: {{ metric_label }}.
                –°–Ω–∞—á–∞–ª–∞ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é, –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ ‚Äî –º–µ–Ω—å—à–µ –º–∞—Ç—á–µ–π.
            </p>

            <ol class="stat-ranking-list stat-ranking-list-wide">
                {% for p in players_list %}
                    <li class="stat-ranking-item {% if forloop.counter == 1 %}top1{% elif forloop.counter == 2 %}top2{% elif forloop.counter == 3 %}top3{% endif %}">
                        <div class="stat-rank-badge">{{ forloop.counter }}</div>

                        {% with p.team_players.all.0 as tp %}
                        <div class="stat-player">
                            <div class="stat-player-avatar">
                                <div class="emblem-sm">
                                    {% if tp and tp.team.emblem %}
                                        <img src="{% static 'emblems/' %}{{ tp.team.emblem }}" alt="{{ tp.team.name }}">
                                    {% elif tp %}
                                        <span>{{ tp.team.name|slice:":2"|upper }}</span>
                                    {% else %}
                                        <span>??</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="stat-player-main">
                                <a href="{% url 'player_detail' p.id %}" class="link stat-player-name">
                                    {{ p.first_name }} {{ p.last_name }}
                                </a>
                                <div class="stat-player-meta muted">
                                    {% if tp %}
                                        {{ tp.team.name }}
                                    {% else %}
                                        –ë–µ–∑ –∫–æ–º–∞–Ω–¥—ã
                                    {% endif %}
                                    ¬∑
                                    {% if p.get_position_display %}
                                        {{ p.get_position_display }}
                                    {% else %}
                                        –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endwith %}

                        <div class="stat-side stat-side-big">
                            <div class="stat-value stat-value-big">
                                {% if tab == 'goals' %}‚öΩ {{ p.goals }}{% endif %}
                                {% if tab == 'assists' %}üéØ {{ p.assists }}{% endif %}
                                {% if tab == 'yellow' %}üü® {{ p.yellow_cards }}{% endif %}
                                {% if tab == 'red' %}üü• {{ p.red_cards }}{% endif %}
                                <span>{{ metric_label }}</span>
                            </div>
                            <div class="stat-games">
                                {{ p.games }} –º–∞—Ç—á(–µ–π)
                            </div>
                        </div>
                    </li>
                {% empty %}
                    <li class="muted">–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</li>
                {% endfor %}
            </ol>
        </div>
    {% endif %}

</section>

<!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<style>
    .stat-ranking-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .stat-ranking-list-wide {
        max-width: 720px;
        margin: 0 auto;
    }

    .stat-ranking-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background-color: #ffffff;
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
        font-size: 12px;
    }

    .stat-ranking-item.top1 {
        border-color: #22c55e;
        box-shadow: 0 0 0 1px #bbf7d0, 0 4px 12px rgba(22, 163, 74, 0.2);
    }
    .stat-ranking-item.top2 {
        border-color: #a7f3d0;
    }
    .stat-ranking-item.top3 {
        border-color: #d1fae5;
    }

    .stat-rank-badge {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        background-color: #ecfdf5;
        border: 1px solid #bbf7d0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: #166534;
        flex-shrink: 0;
    }

    .stat-player {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
    }

    .stat-player-avatar {
        flex-shrink: 0;
    }

    .stat-player-main {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
    }

    .stat-player-name {
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        display: inline-block;
        max-width: 220px;
    }

    .stat-player-meta {
        font-size: 11px;
    }

    .stat-side {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        font-size: 11px;
        min-width: 100px;
        border-left: 1px solid #e5e7eb;
        padding-left: 8px;
    }

    .stat-side-big {
        min-width: 120px;
    }

    .stat-value {
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
    }

    .stat-value span {
        font-size: 10px;
        margin-left: 4px;
        color: #6b7280;
    }

    .stat-value-big {
        font-size: 18px;
        line-height: 1.1;
    }

    .stat-value-big span {
        display: block;
        margin: 0;
    }

    .stat-games {
        color: #6b7280;
        font-size: 11px;
    }
</style>

{% endblock %}
