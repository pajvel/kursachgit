{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ç—á—ë—Ç—ã{% endblock %}

{% block content %}

<section class="form-panel">
    <div class="form-header">
        <h1 class="form-title">–û—Ç—á—ë—Ç—ã –∏ –≤—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
        <p class="form-subtitle">
            –í—ã–±–µ—Ä–∏ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–π ‚Äî –∏ —Å–∫–∞—á–∞–π —Ñ–∞–π–ª.
        </p>
    </div>

    <form method="get">
        <div class="form-body">

            <!-- –®–ê–ì 1: —Ç–∏–ø –æ—Ç—á—ë—Ç–∞ -->
            <div class="event-builder-step">
                <div class="event-builder-step-title">1. –ß—Ç–æ –≤—ã–≥—Ä—É–∂–∞–µ–º</div>

                <!-- —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –≤ –Ω–µ–≥–æ –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø -->
                <input type="hidden" name="kind" id="id_kind" value="{{ kind|default:'' }}">

                <div class="event-type-pills">
                    <button type="button"
                            class="event-pill kind-pill{% if kind == 'players' %} active{% endif %}"
                            data-kind="players">
                        üëï –ò–≥—Ä–æ–∫–∏
                    </button>
                    <button type="button"
                            class="event-pill kind-pill{% if kind == 'teams' %} active{% endif %}"
                            data-kind="teams">
                        üèÜ –ö–æ–º–∞–Ω–¥—ã (—Ç–∞–±–ª–∏—Ü–∞)
                    </button>
                    <button type="button"
                            class="event-pill kind-pill{% if kind == 'matches' %} active{% endif %}"
                            data-kind="matches">
                        üìÖ –ú–∞—Ç—á–∏
                    </button>
                </div>
            </div>

            <!-- –®–ê–ì 1.5: —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ -->
            <div class="event-builder-step">
                <div class="event-builder-step-title">2. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞</div>

                <input type="hidden" name="format" id="id_format" value="{{ fmt|default:'excel' }}">

                <div class="event-type-pills">
                    <button type="button"
                            class="event-pill format-pill{% if fmt == 'excel' or not fmt %} active{% endif %}"
                            data-format="excel">
                        üìä Excel (.xls)
                    </button>
                    <button type="button"
                            class="event-pill format-pill{% if fmt == 'txt' %} active{% endif %}"
                            data-format="txt">
                        üìÑ –¢–µ–∫—Å—Ç–æ–≤—ã–π (.txt)
                    </button>
                </div>

                <p class="form-help" style="margin-top:6px;">
                    Excel –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —Ç–∞–±–ª–∏—á–∫–∞, —Ç–µ–∫—Å—Ç–æ–≤—ã–π ‚Äî –æ–±—ã—á–Ω—ã–π —Ñ–∞–π–ª —Å —Ç–∞–±—É–ª—è—Ü–∏–µ–π.
                </p>
            </div>

            <!-- –®–ê–ì 3: —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ò–ì–†–û–ö–û–í -->
            <div class="event-builder-step"
                 id="players-filters"
                 style="{% if kind != 'players' %}display:none;{% endif %}">
                <div class="event-builder-step-title">3. –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç—á—ë—Ç–∞ –ø–æ –∏–≥—Ä–æ–∫–∞–º</div>

                <!-- —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–≥—Ä–æ–∫–æ–≤ -->
                <input type="hidden" name="team" id="id_team" value="{{ team_id|default:'' }}">
                <input type="hidden" name="position" id="id_position" value="{{ position|default:'' }}">

                <!-- –≤—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã (–∫–∞—Ä—Ç–æ—á–∫–∏, –∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö) -->
                <div class="form-row">
                    <label class="form-label">–ö–æ–º–∞–Ω–¥–∞</label>
                    <div class="team-choice-grid">
                        {% for t in teams %}
                            <div class="team-choice-card team-filter-card
                                 {% if team_id|default:'' == t.id|stringformat:'s' %}active{% endif %}"
                                 data-team-id="{{ t.id }}">
                                <div class="team-choice-emblem">
                                    {% if t.emblem %}
                                        <img src="{% static 'emblems/' %}{{ t.emblem }}" alt="{{ t.name }}">
                                    {% else %}
                                        <span>{{ t.name|slice:":2"|upper }}</span>
                                    {% endif %}
                                </div>
                                <div class="team-choice-body">
                                    <div class="team-choice-name">{{ t.name }}</div>
                                    <div class="team-choice-tag">
                                        {% if t.city %}{{ t.city }}{% else %}–ë–µ–∑ –≥–æ—Ä–æ–¥–∞{% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <p class="form-help">
                        –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ —Å–Ω–∏–º–∞–µ—Ç –≤—ã–±–æ—Ä. –ü—É—Å—Ç–æ = –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã.
                    </p>
                </div>

                <!-- –≤—ã–±–æ—Ä –ø–æ–∑–∏—Ü–∏–∏ (–ø–∏–ª—é–ª–∏) -->
                <div class="form-row" style="margin-top:10px;">
                    <label class="form-label">–ü–æ–∑–∏—Ü–∏—è</label>
                    <div class="position-pills">
                        {% for value, label in positions %}
                            <button type="button"
                                    class="btn btn-ghost btn-small position-filter-btn{% if position == value %} position-btn-active{% endif %}"
                                    data-value="{{ value }}">
                                {{ label }}
                            </button>
                        {% endfor %}
                        <!-- –∫–Ω–æ–ø–∫–∞ "—Å–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é" -->
                        <button type="button"
                                class="btn btn-ghost btn-small position-filter-btn{% if not position %} position-btn-active{% endif %}"
                                data-value="">
                            –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏
                        </button>
                    </div>
                </div>

                <p class="form-help" style="margin-top:6px;">
                    –≠—Ç–∏ —Ñ–∏–ª—å—Ç—Ä—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –æ—Ç—á—ë—Ç ¬´–ò–≥—Ä–æ–∫–∏¬ª.
                </p>
            </div>

            <!-- –®–ê–ì 4: —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ú–ê–¢–ß–ï–ô -->
            <div class="event-builder-step"
                 id="matches-filters"
                 style="{% if kind != 'matches' %}display:none;{% endif %}">
                <div class="event-builder-step-title">3. –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç—á—ë—Ç–∞ –ø–æ –º–∞—Ç—á–∞–º</div>

                <!-- —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–∞—Ç—á–µ–π -->
                <input type="hidden" name="match_team" id="id_match_team" value="{{ match_team_id|default:'' }}">
                <input type="hidden" name="match_status" id="id_match_status" value="{{ match_status|default:'' }}">

                <!-- –∫–æ–º–∞–Ω–¥–∞ –≤ –º–∞—Ç—á–∞—Ö -->
                <div class="form-row">
                    <label class="form-label">–ö–æ–º–∞–Ω–¥–∞ –≤ –º–∞—Ç—á–µ</label>
                    <div class="team-choice-grid">
                        {% for t in teams %}
                            <div class="team-choice-card match-team-filter-card
                                 {% if match_team_id|default:'' == t.id|stringformat:'s' %}active{% endif %}"
                                 data-team-id="{{ t.id }}">
                                <div class="team-choice-emblem">
                                    {% if t.emblem %}
                                        <img src="{% static 'emblems/' %}{{ t.emblem }}" alt="{{ t.name }}">
                                    {% else %}
                                        <span>{{ t.name|slice:":2"|upper }}</span>
                                    {% endif %}
                                </div>
                                <div class="team-choice-body">
                                    <div class="team-choice-name">{{ t.name }}</div>
                                    <div class="team-choice-tag">
                                        {% if t.city %}{{ t.city }}{% else %}–ë–µ–∑ –≥–æ—Ä–æ–¥–∞{% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <p class="form-help">
                        –ü—É—Å—Ç–æ = –º–∞—Ç—á–∏ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥.
                    </p>
                </div>

                <!-- —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞ -->
                <div class="form-row" style="margin-top:10px;">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å –º–∞—Ç—á–∞</label>
                    <div class="event-type-pills">
                        <button type="button"
                                class="event-pill match-status-pill{% if match_status == '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω' %} active{% endif %}"
                                data-status="–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω">
                            üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                        </button>
                        <button type="button"
                                class="event-pill match-status-pill{% if match_status == '–∏–¥—ë—Ç' %} active{% endif %}"
                                data-status="–∏–¥—ë—Ç">
                            ‚è± –ò–¥—ë—Ç
                        </button>
                        <button type="button"
                                class="event-pill match-status-pill{% if match_status == '–∑–∞–≤–µ—Ä—à—ë–Ω' %} active{% endif %}"
                                data-status="–∑–∞–≤–µ—Ä—à—ë–Ω">
                            ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω
                        </button>
                        <button type="button"
                                class="event-pill match-status-pill{% if not match_status %} active{% endif %}"
                                data-status="">
                            –í—Å–µ
                        </button>
                    </div>
                </div>

                <p class="form-help" style="margin-top:6px;">
                    –≠—Ç–∏ —Ñ–∏–ª—å—Ç—Ä—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –æ—Ç—á—ë—Ç ¬´–ú–∞—Ç—á–∏¬ª.
                </p>
            </div>

        </div>

        <div class="form-footer">
            <span class="muted">
                –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ç–∏–ø –æ—Ç—á—ë—Ç–∞, –∑–∞—Ç–µ–º –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–π. –§–∞–π–ª —Å—Ä–∞–∑—É –Ω–∞—á–Ω—ë—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å—Å—è.
            </span>
            <input type="hidden" name="download" value="1">
            <button type="submit" class="btn btn-primary btn-small">
                üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç
            </button>
        </div>
    </form>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const kindInput        = document.getElementById('id_kind');
    const formatInput      = document.getElementById('id_format');
    const teamInput        = document.getElementById('id_team');
    const positionInput    = document.getElementById('id_position');
    const matchTeamInput   = document.getElementById('id_match_team');
    const matchStatusInput = document.getElementById('id_match_status');

    const kindPills   = document.querySelectorAll('.kind-pill');
    const formatPills = document.querySelectorAll('.format-pill');

    const playersFilters  = document.getElementById('players-filters');
    const matchesFilters  = document.getElementById('matches-filters');

    const teamFilterCards       = document.querySelectorAll('.team-filter-card');
    const matchTeamFilterCards  = document.querySelectorAll('.match-team-filter-card');
    const positionFilterBtns    = document.querySelectorAll('.position-filter-btn');
    const matchStatusPills      = document.querySelectorAll('.match-status-pill');

    function updateFiltersVisibility() {
        const kind = kindInput.value;

        if (kind === 'players') {
            playersFilters.style.display = 'block';
            matchesFilters.style.display = 'none';
        } else if (kind === 'matches') {
            playersFilters.style.display = 'none';
            matchesFilters.style.display = 'block';
        } else {
            playersFilters.style.display = 'none';
            matchesFilters.style.display = 'none';
        }
    }

    // –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –æ—Ç—á—ë—Ç–∞
    kindPills.forEach(pill => {
        pill.addEventListener('click', () => {
            kindPills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            kindInput.value = pill.dataset.kind || '';
            updateFiltersVisibility();
        });
    });

    // –≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞
    formatPills.forEach(pill => {
        pill.addEventListener('click', () => {
            formatPills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            formatInput.value = pill.dataset.format || '';
        });
    });

    // —Ñ–∏–ª—å—Ç—Ä: –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
    teamFilterCards.forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.teamId;
            if (teamInput.value === id) {
                // —Å–Ω—è—Ç—å –≤—ã–±–æ—Ä
                teamInput.value = '';
                card.classList.remove('active');
            } else {
                teamFilterCards.forEach(c => c.classList.remove('active'));
                teamInput.value = id;
                card.classList.add('active');
            }
        });
    });

    // —Ñ–∏–ª—å—Ç—Ä: –ø–æ–∑–∏—Ü–∏—è
    positionFilterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            positionFilterBtns.forEach(b => b.classList.remove('position-btn-active'));
            btn.classList.add('position-btn-active');
            positionInput.value = btn.dataset.value || '';
        });
    });

    // —Ñ–∏–ª—å—Ç—Ä: –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –º–∞—Ç—á–µ–π
    matchTeamFilterCards.forEach(card => {
        card.addEventListener('click', () => {
            const id = card.dataset.teamId;
            if (matchTeamInput.value === id) {
                matchTeamInput.value = '';
                card.classList.remove('active');
            } else {
                matchTeamFilterCards.forEach(c => c.classList.remove('active'));
                matchTeamInput.value = id;
                card.classList.add('active');
            }
        });
    });

    // —Ñ–∏–ª—å—Ç—Ä: —Å—Ç–∞—Ç—É—Å –º–∞—Ç—á–µ–π
    matchStatusPills.forEach(pill => {
        pill.addEventListener('click', () => {
            matchStatusPills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            matchStatusInput.value = pill.dataset.status || '';
        });
    });

    // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ø—Ä–∞–≤–∏–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–æ–≤
    updateFiltersVisibility();
});
</script>

{% endblock %}
