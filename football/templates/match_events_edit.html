{% extends 'base.html' %}
{% load static %}

{% block title %}–°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞ {{ match.home_team.name }} ‚Äî {{ match.away_team.name }}{% endblock %}

{% block content %}

<section class="team-block">
    <div class="team-block-header">
        <div>
            <h1 class="team-block-title">
                –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π ¬∑
                <a href="{% url 'match_detail' match.id %}" class="link">
                    {{ match.home_team.name }} ‚Äî {{ match.away_team.name }}
                </a>
            </h1>
            <p class="team-block-subtitle">
                {{ match.date|date:"d.m.Y H:i" }} ¬∑ {{ match.get_status_display }}
            </p>
        </div>
        <a href="{% url 'match_detail' match.id %}" class="btn btn-ghost btn-small">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –º–∞—Ç—á—É
        </a>
    </div>

    {% if errors %}
        <div class="form-errors" style="margin-top:8px;">
            <ul>
                {% for e in errors %}
                    <li>{{ e }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
</section>

<div class="events-layout">

    <!-- –õ–ï–í–û: –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–±—ã—Ç–∏—è -->
    <section class="form-panel">
        <div class="form-header">
            <h2 class="form-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
            <p class="form-subtitle">
                –®–∞–≥ –∑–∞ —à–∞–≥–æ–º: –∫–æ–º–∞–Ω–¥–∞ ‚Üí —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è ‚Üí –≤—Ä–µ–º—è ‚Üí –∏–≥—Ä–æ–∫–∏.
            </p>
        </div>

        <form method="post">
            {% csrf_token %}

            <!-- —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ —É—Ö–æ–¥–∏—Ç –≤–æ view -->
            <input type="hidden" name="event_team" id="id_event_team">
            <input type="hidden" name="event_mode" id="id_event_mode">
            <input type="hidden" name="event_player" id="id_event_player">
            <input type="hidden" name="assist_player" id="id_assist_player">
            <input type="hidden" name="sub_out" id="id_sub_out">
            <input type="hidden" name="sub_in" id="id_sub_in">

            <div class="event-builder">

                <!-- –®–∞–≥ 1. –í—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã -->
                <div class="event-builder-step">
                    <div class="event-builder-step-title">1. –í—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã</div>
                    <div class="team-choice-grid">
                        <div class="team-choice-card"
                             data-team-id="{{ match.home_team.id }}">
                            <div class="team-choice-emblem">
                                {% if match.home_team.emblem %}
                                    <img src="{% static 'emblems/' %}{{ match.home_team.emblem }}" alt="{{ match.home_team.name }}">
                                {% else %}
                                    <span>{{ match.home_team.name|slice:":2"|upper }}</span>
                                {% endif %}
                            </div>
                            <div class="team-choice-body">
                                <div class="team-choice-name">
                                    {{ match.home_team.name }}
                                </div>
                                <div class="team-choice-tag">–•–æ–∑—è–µ–≤–∞</div>
                            </div>
                        </div>

                        <div class="team-choice-card"
                             data-team-id="{{ match.away_team.id }}">
                            <div class="team-choice-emblem">
                                {% if match.away_team.emblem %}
                                    <img src="{% static 'emblems/' %}{{ match.away_team.emblem }}" alt="{{ match.away_team.name }}">
                                {% else %}
                                    <span>{{ match.away_team.name|slice:":2"|upper }}</span>
                                {% endif %}
                            </div>
                            <div class="team-choice-body">
                                <div class="team-choice-name">
                                    {{ match.away_team.name }}
                                </div>
                                <div class="team-choice-tag">–ì–æ—Å—Ç–∏</div>
                            </div>
                        </div>
                    </div>
                    <p class="form-help">–ù–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–æ–º–∞–Ω–¥—ã, –æ—Ç –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–æ–±—ã—Ç–∏–µ.</p>
                </div>

                <!-- –®–∞–≥ 2. –¢–∏–ø —Å–æ–±—ã—Ç–∏—è -->
                <div class="event-builder-step">
                    <div class="event-builder-step-title">2. –¢–∏–ø —Å–æ–±—ã—Ç–∏—è</div>
                    <div class="event-type-pills">
                        <label class="event-pill event-mode-pill" data-mode="goal">
                            <input type="radio" name="event_mode_dummy">
                            ‚öΩ –ì–æ–ª (+ –ø–∞—Å)
                        </label>
                        <label class="event-pill event-mode-pill" data-mode="penalty">
                            <input type="radio" name="event_mode_dummy">
                            ‚öΩ –ü–µ–Ω–∞–ª—å—Ç–∏
                        </label>
                        <label class="event-pill event-mode-pill" data-mode="own">
                            <input type="radio" name="event_mode_dummy">
                            ü•Ö –ê–≤—Ç–æ–≥–æ–ª
                        </label>
                        <label class="event-pill event-mode-pill" data-mode="yellow">
                            <input type="radio" name="event_mode_dummy">
                            üü® –ñ—ë–ª—Ç–∞—è
                        </label>
                        <label class="event-pill event-mode-pill" data-mode="red">
                            <input type="radio" name="event_mode_dummy">
                            üü• –ö—Ä–∞—Å–Ω–∞—è
                        </label>
                        <label class="event-pill event-mode-pill" data-mode="sub">
                            <input type="radio" name="event_mode_dummy">
                            üîÅ –ó–∞–º–µ–Ω–∞
                        </label>
                    </div>
                    <p class="form-help">
                        –ê–≤—Ç–æ–≥–æ–ª: –∫–æ–º–∞–Ω–¥–∞ ‚Äî —Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–±–∏–ª–∞ –≤ —Å–≤–æ–∏ –≤–æ—Ä–æ—Ç–∞ (–µ–π –∑–∞—Å—á–∏—Ç–∞—é—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π).
                    </p>
                </div>

                <!-- –®–∞–≥ 3. –í—Ä–µ–º—è -->
                <div class="event-builder-step" data-mode-section="goal,penalty,own,yellow,red,sub">
                    <div class="event-builder-step-title">3. –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è</div>
                    <div class="event-time-row">
                        <div class="form-row" style="max-width:110px;">
                            <label class="form-label" for="id_event_minute">–ú–∏–Ω—É—Ç–∞</label>
                            <input type="number" min="1" max="90"
                                   name="event_minute"
                                   id="id_event_minute"
                                   class="form-input minute-input"
                                   placeholder="45">
                        </div>
                        <div class="form-row" style="max-width:120px;">
                            <label class="form-label" for="id_event_added_time">+ –∫ –º–∏–Ω—É—Ç–µ</label>
                            <input type="number" min="0" max="15"
                                   name="event_added_time"
                                   id="id_event_added_time"
                                   class="form-input minute-input"
                                   placeholder="0">
                        </div>
                        <div class="form-row" style="flex:1;">
                            <label class="form-label">&nbsp;</label>
                            <p class="form-help" style="margin:0;">
                                –ú–∏–Ω—É—Ç–∞ 1‚Äì90, –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- –®–∞–≥ 4. –ò–≥—Ä–æ–∫–∏ -->
                <div class="event-builder-step" data-mode-section="goal,penalty,own,yellow,red,sub">
                    <div class="event-builder-step-title">4. –£—á–∞—Å—Ç–Ω–∏–∫–∏</div>

                    <!-- –ë–ª–æ–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞) -->

                    <!-- –•–û–ó–Ø–ï–í–ê -->
                    <div class="players-block" data-team-id="{{ match.home_team.id }}">

                        <!-- –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–∫ (–≥–æ–ª / –∞–≤—Ç–æ–≥–æ–ª / –∫–∞—Ä—Ç–æ—á–∫–∞ / –ø–µ–Ω–∞–ª—å—Ç–∏) -->
                        <div class="players-block-section"
                             data-mode-section="goal,penalty,own,yellow,red">
                            <div class="players-block-caption">
                                –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–∫ —Å–æ–±—ã—Ç–∏—è
                                <span class="muted">(–≤ –∑–∞—è–≤–∫–µ {{ match.home_team.name }})</span>
                            </div>
                            <div class="player-grid">
                                {% for lu in home_lineups %}
                                    <div class="player-card"
                                         data-role="main"
                                         data-player-id="{{ lu.player.id }}">
                                        <div class="player-card-header">
                                            <div class="player-card-name">
                                                {{ lu.player.first_name }} {{ lu.player.last_name }}
                                            </div>
                                            <div class="player-card-tag">
                                                {% if lu.is_starting %}
                                                    –°—Ç–∞—Ä—Ç
                                                {% else %}
                                                    –ó–∞–ø–∞—Å
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="player-card-meta">
                                            {% if lu.player.position %}
                                                {{ lu.player.get_position_display }}
                                            {% else %}
                                                –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–π –≥–æ–ª) -->
                        <div class="players-block-section"
                             data-mode-section="goal">
                            <div class="players-block-caption">
                                –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                                <span class="muted">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                            </div>
                            <div class="player-grid">
                                {% for lu in home_lineups %}
                                    <div class="player-card"
                                         data-role="assist"
                                         data-player-id="{{ lu.player.id }}">
                                        <div class="player-card-header">
                                            <div class="player-card-name">
                                                {{ lu.player.first_name }} {{ lu.player.last_name }}
                                            </div>
                                            <div class="player-card-tag">
                                                {% if lu.is_starting %}
                                                    –°—Ç–∞—Ä—Ç
                                                {% else %}
                                                    –ó–∞–ø–∞—Å
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="player-card-meta">
                                            {% if lu.player.position %}
                                                {{ lu.player.get_position_display }}
                                            {% else %}
                                                –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ó–∞–º–µ–Ω–∞: –∫—Ç–æ —É—Ö–æ–¥–∏—Ç / –∫—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç -->
                        <div class="players-block-section"
                             data-mode-section="sub">
                            <div class="players-block-caption">
                                –ó–∞–º–µ–Ω–∞ –≤ {{ match.home_team.name }}
                            </div>

                            <div class="players-subsplit">
                                <div class="players-sub-column">
                                    <div class="players-block-subtitle">
                                        –£—Ö–æ–¥–∏—Ç —Å –ø–æ–ª—è
                                    </div>
                                    <div class="player-grid">
                                        {% for lu in home_lineups %}
                                            <div class="player-card"
                                                 data-role="sub_out"
                                                 data-player-id="{{ lu.player.id }}">
                                                <div class="player-card-header">
                                                    <div class="player-card-name">
                                                        {{ lu.player.first_name }} {{ lu.player.last_name }}
                                                    </div>
                                                    <div class="player-card-tag">
                                                        {% if lu.is_starting %}
                                                            –°—Ç–∞—Ä—Ç
                                                        {% else %}
                                                            –ó–∞–ø–∞—Å
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="player-card-meta">
                                                    {% if lu.player.position %}
                                                        {{ lu.player.get_position_display }}
                                                    {% else %}
                                                        –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="players-sub-column">
                                    <div class="players-block-subtitle">
                                        –í—ã—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–ª–µ
                                    </div>
                                    <div class="player-grid">
                                        {% for lu in home_bench_lineups %}
                                            <div class="player-card"
                                                 data-role="sub_in"
                                                 data-player-id="{{ lu.player.id }}">
                                                <div class="player-card-header">
                                                    <div class="player-card-name">
                                                        {{ lu.player.first_name }} {{ lu.player.last_name }}
                                                    </div>
                                                    <div class="player-card-tag">
                                                        –ó–∞–ø–∞—Å
                                                    </div>
                                                </div>
                                                <div class="player-card-meta">
                                                    {% if lu.player.position %}
                                                        {{ lu.player.get_position_display }}
                                                    {% else %}
                                                        –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- –ì–û–°–¢–ò -->
                    <div class="players-block" data-team-id="{{ match.away_team.id }}">

                        <!-- –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–∫ -->
                        <div class="players-block-section"
                             data-mode-section="goal,penalty,own,yellow,red">
                            <div class="players-block-caption">
                                –û—Å–Ω–æ–≤–Ω–æ–π –∏–≥—Ä–æ–∫ —Å–æ–±—ã—Ç–∏—è
                                <span class="muted">(–≤ –∑–∞—è–≤–∫–µ {{ match.away_team.name }})</span>
                            </div>
                            <div class="player-grid">
                                {% for lu in away_lineups %}
                                    <div class="player-card"
                                         data-role="main"
                                         data-player-id="{{ lu.player.id }}">
                                        <div class="player-card-header">
                                            <div class="player-card-name">
                                                {{ lu.player.first_name }} {{ lu.player.last_name }}
                                            </div>
                                            <div class="player-card-tag">
                                                {% if lu.is_starting %}
                                                    –°—Ç–∞—Ä—Ç
                                                {% else %}
                                                    –ó–∞–ø–∞—Å
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="player-card-meta">
                                            {% if lu.player.position %}
                                                {{ lu.player.get_position_display }}
                                            {% else %}
                                                –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç -->
                        <div class="players-block-section"
                             data-mode-section="goal">
                            <div class="players-block-caption">
                                –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç
                                <span class="muted">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                            </div>
                            <div class="player-grid">
                                {% for lu in away_lineups %}
                                    <div class="player-card"
                                         data-role="assist"
                                         data-player-id="{{ lu.player.id }}">
                                        <div class="player-card-header">
                                            <div class="player-card-name">
                                                {{ lu.player.first_name }} {{ lu.player.last_name }}
                                            </div>
                                            <div class="player-card-tag">
                                                {% if lu.is_starting %}
                                                    –°—Ç–∞—Ä—Ç
                                                {% else %}
                                                    –ó–∞–ø–∞—Å
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="player-card-meta">
                                            {% if lu.player.position %}
                                                {{ lu.player.get_position_display }}
                                            {% else %}
                                                –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- –ó–∞–º–µ–Ω–∞ -->
                        <div class="players-block-section"
                             data-mode-section="sub">
                            <div class="players-block-caption">
                                –ó–∞–º–µ–Ω–∞ –≤ {{ match.away_team.name }}
                            </div>

                            <div class="players-subsplit">
                                <div class="players-sub-column">
                                    <div class="players-block-subtitle">
                                        –£—Ö–æ–¥–∏—Ç —Å –ø–æ–ª—è
                                    </div>
                                    <div class="player-grid">
                                        {% for lu in away_lineups %}
                                            <div class="player-card"
                                                 data-role="sub_out"
                                                 data-player-id="{{ lu.player.id }}">
                                                <div class="player-card-header">
                                                    <div class="player-card-name">
                                                        {{ lu.player.first_name }} {{ lu.player.last_name }}
                                                    </div>
                                                    <div class="player-card-tag">
                                                        {% if lu.is_starting %}
                                                            –°—Ç–∞—Ä—Ç
                                                        {% else %}
                                                            –ó–∞–ø–∞—Å
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="player-card-meta">
                                                    {% if lu.player.position %}
                                                        {{ lu.player.get_position_display }}
                                                    {% else %}
                                                        –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="players-sub-column">
                                    <div class="players-block-subtitle">
                                        –í—ã—Ö–æ–¥–∏—Ç –Ω–∞ –ø–æ–ª–µ
                                    </div>
                                    <div class="player-grid">
                                        {% for lu in away_bench_lineups %}
                                            <div class="player-card"
                                                 data-role="sub_in"
                                                 data-player-id="{{ lu.player.id }}">
                                                <div class="player-card-header">
                                                    <div class="player-card-name">
                                                        {{ lu.player.first_name }} {{ lu.player.last_name }}
                                                    </div>
                                                    <div class="player-card-tag">
                                                        –ó–∞–ø–∞—Å
                                                    </div>
                                                </div>
                                                <div class="player-card-meta">
                                                    {% if lu.player.position %}
                                                        {{ lu.player.get_position_display }}
                                                    {% else %}
                                                        –ë–µ–∑ –ø–æ–∑–∏—Ü–∏–∏
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <div class="form-footer">
                    <span class="muted">
                        –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—ã–¥–µ–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞, —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –∏–≥—Ä–æ–∫.
                    </span>
                    <button type="submit" name="add_event" class="btn btn-primary">
                        + –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
                    </button>
                </div>
            </div>
        </form>
    </section>

    <!-- –ü–†–ê–í–û: —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π + —É–¥–∞–ª–µ–Ω–∏–µ -->
    <section class="team-block events-table-panel">
        <div class="team-block-header">
            <h2 class="team-block-title">–°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞</h2>
            <p class="team-block-subtitle">–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–º–µ—Ç—å –≥–∞–ª–æ—á–∫–∞–º–∏ –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É.</p>
        </div>

        <form method="post" class="events-table-form">
            {% csrf_token %}
            <table class="table players-table small">
                <thead>
                    <tr>
                        <th style="width:26px;"></th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                        <th>–ò–≥—Ä–æ–∫</th>
                        <th>–¢–∏–ø</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in events %}
                        <tr>
                            <td>
                                <input type="checkbox" name="event_id" value="{{ e.id }}">
                            </td>
                            <td class="cell-num">
                                {{ e.minute }}'{% if e.added_time %}+{{ e.added_time }}{% endif %}
                            </td>
                            <td>
                                <span class="muted">
                                    {% if e.team %}
                                        {{ e.team.name }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if e.player %}
                                    <a href="{% url 'player_detail' e.player.id %}" class="link">
                                        {{ e.player.first_name }} {{ e.player.last_name }}
                                    </a>
                                {% else %}
                                    <span class="muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if e.event_type == '–≥–æ–ª' %}
                                    ‚öΩ –ì–æ–ª
                                {% elif e.event_type == '–ø–µ–Ω–∞–ª—å—Ç–∏_–≥–æ–ª' %}
                                    ‚öΩ –ü–µ–Ω–∞–ª—å—Ç–∏
                                {% elif e.event_type == '–∞–≤—Ç–æ–≥–æ–ª' %}
                                    ü•Ö –ê–≤—Ç–æ–≥–æ–ª
                                {% elif e.event_type == '–∞—Å—Å–∏—Å—Ç' %}
                                    üéØ –ê—Å—Å–∏—Å—Ç
                                {% elif e.event_type == '–∂–µ–ª—Ç–∞—è' %}
                                    üü® –ñ—ë–ª—Ç–∞—è
                                {% elif e.event_type == '–∫—Ä–∞—Å–Ω–∞—è' %}
                                    üü• –ö—Ä–∞—Å–Ω–∞—è
                                {% elif e.event_type == '–∑–∞–º–µ–Ω–∞' %}
                                    üîÅ –ó–∞–º–µ–Ω–∞
                                {% else %}
                                    {{ e.event_type }}
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="muted">
                                –ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="delete-footer" style="margin-top:10px;">
                <button type="submit" name="delete_events" class="btn btn-danger btn-small">
                    üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
            </div>
        </form>
    </section>

</div>

<!-- JS –¥–ª—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const teamCards     = document.querySelectorAll('.team-choice-card');
    const modePills     = document.querySelectorAll('.event-mode-pill');
    const playersBlocks = document.querySelectorAll('.players-block');
    const modeSections  = document.querySelectorAll('[data-mode-section]');
    const playerCards   = document.querySelectorAll('.player-card');

    const hiddenTeam   = document.getElementById('id_event_team');
    const hiddenMode   = document.getElementById('id_event_mode');
    const hiddenPlayer = document.getElementById('id_event_player');
    const hiddenAssist = document.getElementById('id_assist_player');
    const hiddenSubOut = document.getElementById('id_sub_out');
    const hiddenSubIn  = document.getElementById('id_sub_in');

    const minuteInput = document.getElementById('id_event_minute');
    const addedInput  = document.getElementById('id_event_added_time');

    // --- –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–æ—Å—Ç–∞–≤–∞–º –∏ –∑–∞–º–µ–Ω–∞–º (–∫–∞–∫ –Ω–∞ –±—ç–∫–µ) ---

    const startingByTeam = {
        "{{ match.home_team.id }}": [
            {% for lu in home_lineups %}
                {% if lu.is_starting %}{{ lu.player.id }},{% endif %}
            {% endfor %}
        ],
        "{{ match.away_team.id }}": [
            {% for lu in away_lineups %}
                {% if lu.is_starting %}{{ lu.player.id }},{% endif %}
            {% endfor %}
        ]
    };

    const subsByTeam = {
        "{{ match.home_team.id }}": [
            {% for e in events %}
                {% if e.event_type == '–∑–∞–º–µ–Ω–∞' and e.team_id == match.home_team.id %}
                    {
                        minute: {% if e.minute %}{{ e.minute }}{% else %}0{% endif %},
                        added : {% if e.added_time %}{{ e.added_time }}{% else %}0{% endif %},
                        player_id: {% if e.player_id %}{{ e.player_id }}{% else %}null{% endif %}
                    },
                {% endif %}
            {% endfor %}
        ],
        "{{ match.away_team.id }}": [
            {% for e in events %}
                {% if e.event_type == '–∑–∞–º–µ–Ω–∞' and e.team_id == match.away_team.id %}
                    {
                        minute: {% if e.minute %}{{ e.minute }}{% else %}0{% endif %},
                        added : {% if e.added_time %}{{ e.added_time }}{% else %}0{% endif %},
                        player_id: {% if e.player_id %}{{ e.player_id }}{% else %}null{% endif %}
                    },
                {% endif %}
            {% endfor %}
        ]
    };

    // –ø–µ—Ä–≤–∞—è –∑–∞–º–µ–Ω–∞ –∏–≥—Ä–æ–∫–∞: –∫–æ–≥–¥–∞ –≤–æ–æ–±—â–µ –≤–ø–µ—Ä–≤—ã–µ –±—ã–ª –≤ —Å–æ–±—ã—Ç–∏–∏ "–∑–∞–º–µ–Ω–∞"
    // kind = 'in' (–≤—ã—à–µ–ª) –∏–ª–∏ 'out' (—É—à—ë–ª)
    const firstSubByPlayer = {}; // playerId -> {minute, added, kind}

    function timeCompare(m1, a1, m2, a2) {
        m1 = m1 || 0; a1 = a1 || 0;
        m2 = m2 || 0; a2 = a2 || 0;
        if (m1 < m2) return -1;
        if (m1 > m2) return 1;
        if (a1 < a2) return -1;
        if (a1 > a2) return 1;
        return 0;
    }

    function formatTime(m, a) {
        if (!m) m = 0;
        if (!a) a = 0;
        return m + "'" + (a ? ("+" + a) : "");
    }

    // —Å—á–∏—Ç–∞–µ–º, —É –∫–∞–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∫–æ–≥–¥–∞ –±—ã–ª–∞ –ø–µ—Ä–≤–∞—è –∑–∞–º–µ–Ω–∞
    function precomputeFirstSubs() {
        for (const teamId in subsByTeam) {
            const subs = subsByTeam[teamId] || [];
            if (!subs.length) continue;

            const starting = new Set(startingByTeam[teamId] || []);
            const onField  = new Set(starting);

            let i = 0;
            while (i < subs.length) {
                const m = subs[i].minute || 0;
                const a = subs[i].added  || 0;

                const group = [];
                while (i < subs.length &&
                       (subs[i].minute || 0) === m &&
                       (subs[i].added  || 0) === a) {
                    group.push(subs[i]);
                    i++;
                }

                const playersInGroup = group
                    .map(ev => ev.player_id)
                    .filter(pid => pid !== null && pid !== undefined);

                const outCandidates = playersInGroup.filter(pid => onField.has(pid));
                const inCandidates  = playersInGroup.filter(pid => !onField.has(pid));

                outCandidates.forEach(pid => {
                    if (!firstSubByPlayer[pid]) {
                        firstSubByPlayer[pid] = {minute: m, added: a, kind: 'out'};
                    }
                    onField.delete(pid);
                });

                inCandidates.forEach(pid => {
                    if (!firstSubByPlayer[pid]) {
                        firstSubByPlayer[pid] = {minute: m, added: a, kind: 'in'};
                    }
                    onField.add(pid);
                });
            }
        }

        // –ø–æ–¥–ø–∏—Å—å "–≤—ã—à–µ–ª/—É—à—ë–ª" –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫—É
        playerCards.forEach(card => {
            const pid = parseInt(card.dataset.playerId || "", 10);
            if (!pid) return;
            const info = firstSubByPlayer[pid];
            if (!info) return;

            card.dataset.firstSubMinute = info.minute;
            card.dataset.firstSubAdded  = info.added || 0;

            const meta = card.querySelector('.player-card-meta');
            if (meta) {
                const extra = document.createElement('div');
                extra.classList.add('muted');
                const verb = info.kind === 'in' ? '–í—ã—à–µ–ª –Ω–∞ ' : '–£—à—ë–ª –Ω–∞ ';
                extra.textContent = verb + formatTime(info.minute, info.added);
                meta.appendChild(extra);
            }
        });
    }

    // –∫—Ç–æ –Ω–∞ –ø–æ–ª–µ –∫ –º–æ–º–µ–Ω—Ç—É (minute, added) –¥–ª—è –∫–æ–º–∞–Ω–¥—ã teamId
    function getOnField(teamId, minute, added) {
        const start = startingByTeam[teamId] || [];
        const onField = new Set(start);
        const subs = subsByTeam[teamId] || [];

        const targetMinute = minute || 0;
        const targetAdded  = added || 0;

        for (let i = 0; i < subs.length; i++) {
            const ev = subs[i];
            const m = ev.minute || 0;
            const a = ev.added  || 0;

            if (m > targetMinute || (m === targetMinute && a >= targetAdded)) {
                break;
            }

            const pid = ev.player_id;
            if (!pid) continue;

            if (onField.has(pid)) {
                onField.delete(pid);
            } else {
                onField.add(pid);
            }
        }
        return onField;
    }

    function resetPlayersSelection() {
        hiddenPlayer.value = '';
        hiddenAssist.value = '';
        hiddenSubOut.value = '';
        hiddenSubIn.value  = '';
        playerCards.forEach(c => c.classList.remove('selected'));
    }

    // –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç / –ø—Ä—è—á–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç "—Ä–∞–Ω–Ω–∏–µ" –∑–∞–º–µ–Ω—ã
    function updatePlayersVisibility() {
        const teamId = hiddenTeam.value;
        const mode   = hiddenMode.value;

        const minute = parseInt(minuteInput.value, 10);
        const added  = parseInt(addedInput.value, 10);

        const hasTeam   = !!teamId;
        const hasMode   = !!mode;
        const hasMinute = !isNaN(minute);

        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å—ë —Å–ø—Ä—è—Ç–∞—Ç—å
        playersBlocks.forEach(block => {
            block.classList.remove('visible');
        });
        playerCards.forEach(card => {
            card.style.display = 'none';
            card.style.opacity = '';
            card.style.pointerEvents = '';
        });

        // –ø–æ–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã –∫–æ–º–∞–Ω–¥–∞ + —Ç–∏–ø + –º–∏–Ω—É—Ç–∞ ‚Äî –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        if (!hasTeam || !hasMode || !hasMinute) {
            return;
        }

        // –ø–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
        playersBlocks.forEach(block => {
            if (String(block.dataset.teamId) === String(teamId)) {
                block.classList.add('visible');
            }
        });

        const onField = getOnField(
            String(teamId),
            minute,
            isNaN(added) ? 0 : added
        );

        playerCards.forEach(card => {
            const block = card.closest('.players-block');
            if (!block || String(block.dataset.teamId) !== String(teamId)) {
                card.style.display = 'none';
                return;
            }

            const role = card.dataset.role;
            const pid  = parseInt(card.dataset.playerId || "", 10);
            if (!pid) {
                card.style.display = 'none';
                return;
            }

            let visible = false;

            if (mode === 'sub') {
                // –∑–∞–º–µ–Ω–∞: —É—Ö–æ–¥–∏—Ç ‚Äî —Ç–æ–ª—å–∫–æ –∫—Ç–æ –Ω–∞ –ø–æ–ª–µ, –≤—ã—Ö–æ–¥–∏—Ç ‚Äî —Ç–æ–ª—å–∫–æ –∫—Ç–æ –ù–ï –Ω–∞ –ø–æ–ª–µ
                if (role === 'sub_out') {
                    visible = onField.has(pid);
                } else if (role === 'sub_in') {
                    visible = !onField.has(pid);
                }
            } else {
                // –≥–æ–ª, –ø–∞—Å, –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∏ –Ω–∞ –ø–æ–ª–µ
                if (role === 'main' || role === 'assist') {
                    visible = onField.has(pid);
                }
            }

            if (!visible) {
                card.style.display = 'none';
                card.classList.remove('selected');
                return;
            }

            // –∑–¥–µ—Å—å –∏–≥—Ä–æ–∫ –≤–∏–¥–µ–Ω; –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—Ç–∞–≤–∏–º –ª–∏ —Å–æ–±—ã—Ç–∏–µ "–¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω –≤–æ–æ–±—â–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –∑–∞–º–µ–Ω–µ"
            let disabledByTime = false;
            if (mode === 'sub' && (role === 'sub_out' || role === 'sub_in')) {
                const firstMin = parseInt(card.dataset.firstSubMinute || "", 10);
                const firstAdd = parseInt(card.dataset.firstSubAdded || "", 10) || 0;

                if (!isNaN(firstMin)) {
                    const cmp = timeCompare(
                        minute,
                        isNaN(added) ? 0 : added,
                        firstMin,
                        firstAdd
                    );
                    // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–∏–Ω—É—Ç–∞ –ú–ï–ù–¨–®–ï –ø–µ—Ä–≤–æ–π –∑–∞–º–µ–Ω—ã –∏–≥—Ä–æ–∫–∞ ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º
                    if (cmp < 0) {
                        disabledByTime = true;
                    }
                }
            }

            card.style.display = '';
            if (disabledByTime) {
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            } else {
                card.style.opacity = '';
                card.style.pointerEvents = '';
            }
        });
    }

    // –≤—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã
    teamCards.forEach(card => {
        card.addEventListener('click', () => {
            teamCards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            hiddenTeam.value = card.dataset.teamId;

            resetPlayersSelection();
            updatePlayersVisibility();
        });
    });

    // –≤—ã–±–æ—Ä —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
    modePills.forEach(pill => {
        pill.addEventListener('click', () => {
            modePills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');

            const mode = pill.dataset.mode;
            hiddenMode.value = mode;

            // –≤–∫–ª—é—á–∞–µ–º / –≤—ã–∫–ª—é—á–∞–µ–º —á–∞—Å—Ç–∏ —Ñ–æ—Ä–º—ã
            modeSections.forEach(sec => {
                const modes = sec.dataset.modeSection.split(',');
                if (modes.indexOf(mode) !== -1) {
                    sec.style.display = 'block';
                } else {
                    sec.style.display = 'none';
                }
            });

            resetPlayersSelection();
            updatePlayersVisibility();
        });
    });

    // –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∏–Ω—É—Ç—ã / –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    minuteInput.addEventListener('input', () => {
        resetPlayersSelection();
        updatePlayersVisibility();
    });

    addedInput.addEventListener('input', () => {
        resetPlayersSelection();
        updatePlayersVisibility();
    });

    // –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω –Ω–µ "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
    playerCards.forEach(card => {
        card.addEventListener('click', () => {
            const minute = parseInt(minuteInput.value, 10);
            if (!hiddenTeam.value || !hiddenMode.value || isNaN(minute)) {
                return;
            }
            if (card.style.pointerEvents === 'none') {
                // –∏–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á—ë–Ω –∏–∑-–∑–∞ "—Ä–∞–Ω–Ω–µ–≥–æ" –≤—Ä–µ–º–µ–Ω–∏
                return;
            }

            const role = card.dataset.role;
            const pid  = card.dataset.playerId;

            if (role === 'main') {
                document.querySelectorAll('.player-card[data-role="main"]').forEach(c => {
                    c.classList.remove('selected');
                });
                card.classList.add('selected');
                hiddenPlayer.value = pid;

            } else if (role === 'assist') {
                if (hiddenAssist.value === pid) {
                    hiddenAssist.value = '';
                    card.classList.remove('selected');
                } else {
                    document.querySelectorAll('.player-card[data-role="assist"]').forEach(c => {
                        c.classList.remove('selected');
                    });
                    hiddenAssist.value = pid;
                    card.classList.add('selected');
                }

            } else if (role === 'sub_out') {
                document.querySelectorAll('.player-card[data-role="sub_out"]').forEach(c => {
                    c.classList.remove('selected');
                });
                card.classList.add('selected');
                hiddenSubOut.value = pid;

            } else if (role === 'sub_in') {
                document.querySelectorAll('.player-card[data-role="sub_in"]').forEach(c => {
                    c.classList.remove('selected');
                });
                card.classList.add('selected');
                hiddenSubIn.value = pid;
            }
        });
    });

    precomputeFirstSubs();
});
</script>

{% endblock %}
